<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>穷折腾</title>
    <meta name="description" content="zqqf16 的个人博客" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="/assets/favicon.ico">
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    
<link rel="stylesheet" type="text/css" href="/assets/css/pygments.css" />

</head>
<body class="post-template tag-fables nav-closed">
    
    <div class="site-wrapper">
        


<header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        
        <a class="blog-logo" href="http://blog.zorro.im">
            <img src="/static/img/favicon.png" alt="穷折腾" />
        </a>
        
        
    </nav>
</header>
<main class="content" role="main">
    <article class="post ">
        <header class="post-header">
            <h1 class="post-title">ProxyChains 及其原理</h1>
            <section class="post-meta">
                <time class="post-date" datetime="2015-06-25">25 Jun 2015</time>
                
                     on 
                    
                    <a href="/tags/ProxyChains.html"> ProxyChains </a>
                    
                
            </section>
        </header>
        <section class="post-content">
            <h2 id="_1">前言</h2>
<p>Shadowsocks 是一个非常好用的 SOCKS 代理程序，尤其在 Mac 上，基本上只要支持系统代理的应用都直接可以一键爬墙了。</p>
<p>但是有些底层的应用，比如那些传统的 Unix 命令行工具，就不会搭理系统的代理了，甚至绝大多数压根就不支持 SOCKS 代理。</p>
<p>以前，我一般都会用 L2TP 或 IPSec 这样的底层 VPN 来搞定，不仅麻烦，而且越来越不稳定（原因你懂的……）。</p>
<p>直到后来发现了 ProxyChains。</p>
<h2 id="_2">安装以及使用</h2>
<p>ProxyChains 的项目地址在 <a href="https://github.com/rofl0r/proxychains-ng">Github</a></p>
<p>在 Mac 下安装十分简单：</p>
<div class="codehilite"><pre>brew install proxychains-ng
</pre></div>


<p>然后编辑配置文件 <strong>/usr/local/etc/proxychains.conf</strong>，在末尾加上：</p>
<div class="codehilite"><pre># Shadowsocks
socks5 127.0.0.1 1080
</pre></div>


<blockquote>
<p>2015-9-15 更新</p>
<p>OS X El Capitan v10.11 之后，Apple 推出了一个叫 <strong>System Integrity Protection</strong> 的新功能：</p>
<blockquote>
<p>A new security policy that applies to every running process, including privileged code and code that runs out of the sandbox. The policy extends additional protections to components on disk and at run-time, only allowing system binaries to be modified by the system installer and software updates. <strong>Code injection and runtime attachments to system binaries are no longer permitted</strong>.</p>
</blockquote>
<p>如果开启了 SIP，可能导致 ProxyChains 失效。解决方法是进入 Recovery 模式，在终端执行 <code>csrutil disable</code>，禁止 SIP。</p>
<p>其中的风险请自行判断:-)</p>
</blockquote>
<p>使用方法也很简单，比如 ping：</p>
<div class="codehilite"><pre><span class="nv">$ </span>proxychains4 ping -c <span class="m">2</span> www.google.com
<span class="o">[</span>proxychains<span class="o">]</span> config file found: /usr/local/Cellar/proxychains-ng/4.7/etc/proxychains.conf
<span class="o">[</span>proxychains<span class="o">]</span> preloading /usr/local/Cellar/proxychains-ng/4.7/lib/libproxychains4.dylib
<span class="o">[</span>proxychains<span class="o">]</span> DLL init
PING www.google.com <span class="o">(</span>216.58.221.132<span class="o">)</span>: <span class="m">56</span> data bytes
<span class="m">64</span> bytes from 216.58.221.132: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">0</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">41</span> <span class="nb">time</span><span class="o">=</span>65.601 ms
<span class="m">64</span> bytes from 216.58.221.132: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">41</span> <span class="nb">time</span><span class="o">=</span>66.572 ms

--- www.google.com ping statistics ---
<span class="m">2</span> packets transmitted, <span class="m">2</span> packets received, 0.0% packet loss
round-trip min/avg/max/stddev <span class="o">=</span> 65.601/66.087/66.572/0.486 ms
</pre></div>


<p>当然，需要先启动 Shadowsocks。</p>
<h2 id="_3">原理</h2>
<p>在其主页上，它是这样描述的：</p>
<blockquote>
<p>proxychains ng (new generation) - a preloader which hooks calls to sockets in dynamically linked programs and redirects it through one or more socks/http proxies. continuation of the unmaintained proxychains project.</p>
</blockquote>
<p>简单的说就是这个程序 Hook 了 sockets 相关的操作，让普通程序的 sockets 数据走 SOCKS/HTTP 代理。</p>
<p>其核心就是利用了 <strong>LD_PRELOAD</strong> 这个环境变量（Mac 上是 <strong>DYLD_INSERT_LIBRARIES</strong>）。</p>
<p>在 Unix 系统中，如果设置了 LD_PRELOAD 环境变量，那么在程序运行时，动态链接器会先加载该环境变量所指定的动态库。也就是说，这个动态库的加载优先于任何其它的库，包括 libc。</p>
<p>ProxyChains 创建了一个叫 libproxychains4.so（Mac 上是 libproxychains4.dylib）的动态库。里面重写了 <code>connect</code>、<code>close</code> 以及 <code>sendto</code> 等与 socket 相关的函数，通过这些函数发出的数据将会走代理，详细代码可以参考 libproxychains.c。</p>
<p>在主程序里，它会读取配置文件，查找 libproxychains4 所在位置，把这些信息存入环境变量后执行子程序。这样子程序里对 socket 相关的函数调用就会被 Hook 了，对子程序来说，跟代理相关的东西都是透明的。</p>
<p>可以用 printenv 程序来查看增加的环境变量，在 Mac 上，输出结果类似于：</p>
<div class="codehilite"><pre><span class="nv">$ </span>proxychains4 printenv
<span class="o">[</span>proxychains<span class="o">]</span> config file found: /usr/local/Cellar/proxychains-ng/4.7/etc/proxychains.conf
<span class="o">[</span>proxychains<span class="o">]</span> preloading /usr/local/Cellar/proxychains-ng/4.7/lib/libproxychains4.dylib
<span class="o">[</span>proxychains<span class="o">]</span> DLL init
...
<span class="nv">PROXYCHAINS_CONF_FILE</span><span class="o">=</span>/usr/local/Cellar/proxychains-ng/4.7/etc/proxychains.conf
<span class="nv">DYLD_INSERT_LIBRARIES</span><span class="o">=</span>/usr/local/Cellar/proxychains-ng/4.7/lib/libproxychains4.dylib
<span class="nv">DYLD_FORCE_FLAT_NAMESPACE</span><span class="o">=</span>1
</pre></div>


<p>一共设置了三个环境变量，其中 <strong>PROXYCHAINS_CONF_FILE</strong> 保存的是配置文件路径，<strong>DYLD_INSERT_LIBRARIES</strong> 保存的是动态库路径，在 Mac 中，必须使<strong>DYLD_FORCE_FLAT_NAMESPACE</strong> 为 1 才能保证 <strong>DYLD_INSERT_LIBRARIES</strong> 起作用。</p>
<p>其实还有个一劳永逸的方法：</p>
<p>手动设置这三个环境变量</p>
<div class="codehilite"><pre><span class="nv">$ </span><span class="nb">export </span><span class="nv">PROXYCHAINS_CONF_FILE</span><span class="o">=</span>/usr/local/Cellar/proxychains-ng/4.7/etc/proxychains.conf
<span class="nv">$ </span><span class="nb">export </span><span class="nv">DYLD_INSERT_LIBRARIES</span><span class="o">=</span>/usr/local/Cellar/proxychains-ng/4.7/lib/libproxychains4.dylib
<span class="nv">$ </span><span class="nb">export </span><span class="nv">DYLD_FORCE_FLAT_NAMESPACE</span><span class="o">=</span>1
</pre></div>


<p>这样在当前 shell 中运行的所有程序的网络请求都会走代理了。</p>
<h2 id="_4">参考链接</h2>
<ol>
<li><a href="http://blog.csdn.net/haoel/article/details/1602108">警惕 UNIX 下的 LD_PRELOAD 环境变量</a></li>
<li><a href="http://hbprotoss.github.io/posts/li-yong-ld_preloadjin-xing-hook.html">利用 LD_PRELOAD 进行 hook</a></li>
<li><a href="http://www.dreamxu.com/proxychains-ng/">Mac 下安装及配置 ProxyChains-NG 实现终端下代理</a></li>
<li><a href="https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man1/dyld.1.html">dyld - the dynamic link editor</a></li>
</ol>
        </section>
        <footer class="post-footer">
        
        <figure class="author-image">
            <a class="img" href="http://blog.zorro.im/posts/about.html" style="background-image: url(http://s.gravatar.com/avatar/4062f9b2373a5519a3b97012489d4bc1?s=80)"><span class="hidden">zqqf16's Picture</span></a>
        </figure>
        
        <section class="author">
            <h4><a href="http://blog.zorro.im/posts/about.html">zqqf16</a></h4>
            
                <p>手工艺人</p>
            
            <div class="author-meta">
                
                <span class="author-location icon-location">Beijing</span>
                
                
                <span class="author-link icon-link"><a href="http://blog.zorro.im/posts/about.html">http://blog.zorro.im/posts/about.html</a></span>
                
            </div>
        </section>
            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="https://twitter.com/intent/tweet?text=ProxyChains 及其原理&amp;url=http://blog.zorro.im/posts/proxychians.html"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://blog.zorro.im/posts/proxychians.html"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=http://blog.zorro.im/posts/proxychians.html"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>
        </footer>
    </article>
</main>
<aside class="read-next">
    
    <a class="read-next-story no-cover" href="/posts/taian_jinan.html">
        <section class="post">
            <h2>泰安济南两日游</h2>
            <p>&hellip;</p>
        </section>
    </a>
    
    
    <a class="read-next-story prev no-cover" href="/posts/prototype_before_polishing.html">
        <section class="post">
            <h2>雕琢前先得有原型，跑之前先学会走</h2>
            <p>&hellip;</p>
        </section>
    </a>
    
</aside>

        <footer class="site-footer clearfix">
            <section class="copyright"><a href="http://blog.zorro.im">穷折腾</a> &copy; 2015</section>
            <section class="poweredby">Proudly published with <a href="https://ghost.org">Ghost</a></section>
        </footer>
    </div>
    
    <script type="text/javascript" src="/assets/js/jquery-1.11.3.min.js"></script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>
</body>
</html>