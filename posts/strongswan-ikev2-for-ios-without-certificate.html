<!DOCTYPE html>
<html lang="zh-cn">
<head>
  
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
  <title>
用 strongSwan 搭建免证书的 IKEv2 VPN |
穷折腾</title>
  <link rel="stylesheet" href="/static/css/style.css" />
  <link rel="stylesheet" href="/static/css/pygments.css" />
  <link rel="alternate" type="application/rss+xml" title="RSS" href="http://blog.zorro.im/rss.xml" />
  <link rel="sitemap"  type="application/xml" title="Sitemap" href="/sitemap.xml" />
  <link rel="icon" type="image/png" href="/static/img/favicon.png">
</head>
<body>
    <div  class="page-wrap">
        <section class="main-header regular">
            <div class="vertical-container">
                <div class="wrapper clearfix">
                    <header>
                        <a href="/">
                            <h1 id="main-title">穷折腾</h1>
                            <h2 id="main-subtitle">zqqf16 的个人博客</h2>
                        </a>
                    </header>
                    <nav id="main-nav" role="navigation">
                        <a href="/" class="selected">主页</a>
                        <a href="/posts/about.html" class="">关于</a>
                        <a href="https://github.com/zqqf16">Github</a>
                    </nav>
                </div>
            </div>
        </section>
        <section class="main-content">
            
<article class="main-content">
    <div class="wrapper" itemscope itemtype="http://schema.org/Article">
        <header class="section-header">
            <h1 itemprop="headline" class="section-title">用 strongSwan 搭建免证书的 IKEv2 VPN</h1>
            <span class="section-subtitle">
                <address class="author">By <a itemprop="author" rel="author" href="/posts/about.html">zqqf16</a></address>
                on <time itemprop="datePublished" content="2015-10-14" datetime="2015-10-14" pubdate="2015-10-14">2015-10-14</time>
            </span>
        </header>
        <section itemprop="articleBody" class="post-content">
        	<h2 id="_1">前言</h2>
<p>目前能搜到的 strongSwan IKEv2 配置基本上都是基于证书的，不知道别人怎么样，反正我觉得证书方式挺繁琐的，虽然跟证书打了三年多的交道。</p>
<p>如果只是在 iOS 或者 OS X 上用 IKEv2，用 PSK（预共享密钥）的方式就简单很多。</p>
<p><em>本文仅限于科学研究使用，请勿用于其他目的。所有配置文件可以在 <a href="https://gist.github.com/zqqf16/b207a17637de103e05c6">Gist</a> 上获取。</em></p>
<h2 id="_2">服务端配置</h2>
<h3 id="1-strongswan">1. 安装 strongSwan</h3>
<p>我是在 Ubuntu 下安装的，如果图省事，可以直接 <code>apt-get install strongSwan</code> 搞定，源里的版本已经是 5.x 了，不算太旧。</p>
<p>如果想安装最新的，可以自行下载编译。</p>
<div class="codehilite"><pre><span class="c"># Download strongSwan</span>
wget https://download.strongswan.org/strongswan-5.3.3.tar.gz

<span class="c"># Extract and uncompress</span>
tar -vzxf strongswan-5.3.3.tar.gz

<span class="nb">cd </span>strongswan-5.3.3

<span class="c"># Configure</span>
./configure --prefix<span class="o">=</span>/usr --sysconfdir<span class="o">=</span>/etc  --enable-openssl --enable-nat-transport --disable-mysql --disable-ldap  --disable-static --enable-shared --enable-md4 --enable-eap-mschapv2 --enable-eap-aka --enable-eap-aka-3gpp2  --enable-eap-gtc --enable-eap-identity --enable-eap-md5 --enable-eap-peap --enable-eap-radius --enable-eap-sim --enable-eap-sim-file --enable-eap-simaka-pseudonym --enable-eap-simaka-reauth --enable-eap-simaka-sql --enable-eap-tls --enable-eap-tnc --enable-eap-ttls

<span class="c"># Make &amp; install</span>
make <span class="o">&amp;&amp;</span> make install
</pre></div>


<h3 id="2-strongswan">2. strongSwan 配置</h3>
<p>编辑 /etc/ipsec.conf</p>
<div class="codehilite"><pre># ipsec.conf - strongSwan IPsec configuration file

# basic configuration

config setup
    strictcrlpolicy=no
    uniqueids = no

# IKEv2 for iOS

conn iOS-IKEV2
    auto=add
    dpdaction=clear
    keyexchange=ikev2

    #left
    left=%any
    leftsubnet=0.0.0.0/0
    leftauth=psk
    leftid=im.zorro.ipsec.server

    #right
    right=%any
    rightsourceip=10.99.1.0/24
    rightauth=eap-mschapv2
    rightid=im.zorro.ipsec.client
</pre></div>


<p>需要注意的点是 <code>leftauth=psk</code> 与 <code>rightauth=eap-mschapv2</code>，分别对应着 iOS／OS X 中的“设备鉴定”与“EAP 鉴定”。
“rightauth” 的方法有很多，比如 “eap-md5” 这样的，iOS 不一定能支持，有时间的可以多尝试几个～</p>
<p><em>PS：个人觉得 Apple 的命名方式挺容易理解的，不知道 strongSwan 为啥要叫 left 和 right。</em></p>
<p>至于 <code>rightsourceip</code>，根据使用者的网络情况，别跟客户端子网冲突了就行，比如 <code>172.16.x.x</code>、<code>10.x.x.x</code>、<code>192.168.x.x</code>。</p>
<p><code>leftid</code> 与 <code>rightid</code> 分别对应着<strong>远程标识符</strong>（RemoteIdentifier）和<strong>局部标识符</strong>（LocalIdentifier），随便选个顺眼的即可。</p>
<h3 id="3-psk">3. PSK 与用户名密码</h3>
<p>编辑 /etc/ipsec.secrets</p>
<div class="codehilite"><pre>: PSK yourpresharedkey
u1 : EAP &quot;password&quot;
u2 : EAP &quot;password&quot;
</pre></div>


<p><code>: PSK yourpresharedkey</code> 这行要填预共享密钥，下面的 u1、u2 是添加的两个用户。</p>
<h3 id="4-ip-table">4. 配置 IP Table</h3>
<p>执行以下代码：</p>
<div class="codehilite"><pre><span class="c">#!/bin/bash</span>

<span class="c"># Add ip tables</span>

iptables -A INPUT -p udp --dport <span class="m">500</span> -j ACCEPT
iptables -A INPUT -p udp --dport <span class="m">4500</span> -j ACCEPT
<span class="nb">echo </span><span class="m">1</span> &gt; /proc/sys/net/ipv4/ip_forward
iptables -t nat -A POSTROUTING -s 10.99.1.0/24 -o eth0 -j MASQUERADE
iptables -A FORWARD -s 10.99.1.0/24 -j ACCEPT
</pre></div>


<p>注意：<strong>网段要跟 ipsec.conf 里配置的一致</strong>。</p>
<h3 id="5-dns">5. 配置 DNS</h3>
<p>编辑 /etc/strongswan.conf</p>
<div class="codehilite"><pre>charon {
        load_modular = yes

        dns1 = 8.8.8.8
        dns2 = 8.8.4.4

        plugins {
                include strongswan.d/charon/*.conf
        }
}

include strongswan.d/*.conf
</pre></div>


<h3 id="6-strongswan">6. 启动 strongSwan</h3>
<p>启动：<code>ipsec start</code></p>
<p>重新加载配置文件：<code>ipsec reload</code></p>
<p>重新加载用户名密码文件：<code>ipsec rereadsecrets</code></p>
<h2 id="_3">客户端配置</h2>
<p>虽然从 iOS 9 开始，系统设置中可以手动添加 IKEv2 配置了，但是没法输入 PSK，也不知道 Apple 咋想的。</p>
<p>最靠谱的方式还是用配置文件方式，推荐用 Apple Configurator。</p>
<p>其中：</p>
<ul>
<li><strong>设备鉴定</strong>选择<strong>共享密钥</strong></li>
<li>勾上<strong>启用 EAP</strong></li>
<li><strong>EAP 鉴定</strong>选择<strong>用户名/密码</strong></li>
</ul>
<p><em>PS：我用 Apple Configurator 2，可能是 Beta 的缘故，编辑的时候总是提示有错误，却死活找不着错误的地方……</em></p>
<p>如果没有 Apple Configurator，可以手工编辑下面的文件：</p>
<div class="codehilite"><pre>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;
&lt;plist version=&quot;1.0&quot;&gt;
&lt;dict&gt;
    &lt;key&gt;PayloadContent&lt;/key&gt;
    &lt;array&gt;
        &lt;dict&gt;
            &lt;key&gt;IKEv2&lt;/key&gt;
            &lt;dict&gt;
                &lt;key&gt;AuthName&lt;/key&gt;
                &lt;string&gt;{username}&lt;/string&gt;
                &lt;key&gt;AuthPassword&lt;/key&gt;
                &lt;string&gt;{password}&lt;/string&gt;
                &lt;key&gt;AuthenticationMethod&lt;/key&gt;
                &lt;string&gt;SharedSecret&lt;/string&gt;
                &lt;key&gt;ChildSecurityAssociationParameters&lt;/key&gt;
                &lt;dict&gt;
                    &lt;key&gt;DiffieHellmanGroup&lt;/key&gt;
                    &lt;integer&gt;2&lt;/integer&gt;
                    &lt;key&gt;EncryptionAlgorithm&lt;/key&gt;
                    &lt;string&gt;3DES&lt;/string&gt;
                    &lt;key&gt;IntegrityAlgorithm&lt;/key&gt;
                    &lt;string&gt;SHA1-96&lt;/string&gt;
                    &lt;key&gt;LifeTimeInMinutes&lt;/key&gt;
                    &lt;integer&gt;1440&lt;/integer&gt;
                &lt;/dict&gt;
                &lt;key&gt;DeadPeerDetectionRate&lt;/key&gt;
                &lt;string&gt;Medium&lt;/string&gt;
                &lt;key&gt;DisableMOBIKE&lt;/key&gt;
                &lt;false/&gt;
                &lt;key&gt;DisableRedirect&lt;/key&gt;
                &lt;integer&gt;0&lt;/integer&gt;
                &lt;key&gt;EnableCertificateRevocationCheck&lt;/key&gt;
                &lt;false/&gt;
                &lt;key&gt;EnablePFS&lt;/key&gt;
                &lt;false/&gt;
                &lt;key&gt;ExtendedAuthEnabled&lt;/key&gt;
                &lt;true/&gt;
                &lt;key&gt;IKESecurityAssociationParameters&lt;/key&gt;
                &lt;dict&gt;
                    &lt;key&gt;DiffieHellmanGroup&lt;/key&gt;
                    &lt;integer&gt;2&lt;/integer&gt;
                    &lt;key&gt;EncryptionAlgorithm&lt;/key&gt;
                    &lt;string&gt;3DES&lt;/string&gt;
                    &lt;key&gt;IntegrityAlgorithm&lt;/key&gt;
                    &lt;string&gt;SHA1-96&lt;/string&gt;
                    &lt;key&gt;LifeTimeInMinutes&lt;/key&gt;
                    &lt;integer&gt;1440&lt;/integer&gt;
                &lt;/dict&gt;
                &lt;key&gt;LocalIdentifier&lt;/key&gt;
                &lt;string&gt;{rightid}&lt;/string&gt;
                &lt;key&gt;RemoteAddress&lt;/key&gt;
                &lt;string&gt;{your_server_address}&lt;/string&gt;
                &lt;key&gt;RemoteIdentifier&lt;/key&gt;
                &lt;string&gt;{leftid}&lt;/string&gt;
                &lt;key&gt;SharedSecret&lt;/key&gt;
                &lt;string&gt;{your_psk}&lt;/string&gt;
                &lt;key&gt;UseConfigurationAttributeInternalIPSubnet&lt;/key&gt;
                &lt;false/&gt;
            &lt;/dict&gt;
            &lt;key&gt;IPv4&lt;/key&gt;
            &lt;dict&gt;
                &lt;key&gt;OverridePrimary&lt;/key&gt;
                &lt;integer&gt;1&lt;/integer&gt;
            &lt;/dict&gt;
            &lt;key&gt;PayloadDescription&lt;/key&gt;
            &lt;string&gt;Configures VPN settings&lt;/string&gt;
            &lt;key&gt;PayloadDisplayName&lt;/key&gt;
            &lt;string&gt;VPN&lt;/string&gt;
            &lt;key&gt;PayloadIdentifier&lt;/key&gt;
            &lt;string&gt;com.apple.vpn.managed.10D1B7B7-57C1-4AFD-A51E-DD496017EA14&lt;/string&gt;
            &lt;key&gt;PayloadType&lt;/key&gt;
            &lt;string&gt;com.apple.vpn.managed&lt;/string&gt;
            &lt;key&gt;PayloadUUID&lt;/key&gt;
            &lt;string&gt;F8362154-56D1-434D-AA7A-4CEA68A2C543&lt;/string&gt;
            &lt;key&gt;PayloadVersion&lt;/key&gt;
            &lt;real&gt;1&lt;/real&gt;
            &lt;key&gt;Proxies&lt;/key&gt;
            &lt;dict/&gt;
            &lt;key&gt;UserDefinedName&lt;/key&gt;
            &lt;string&gt;IKEV2&lt;/string&gt;
            &lt;key&gt;VPNType&lt;/key&gt;
            &lt;string&gt;IKEv2&lt;/string&gt;
        &lt;/dict&gt;
    &lt;/array&gt;
    &lt;key&gt;PayloadDisplayName&lt;/key&gt;
    &lt;string&gt;IKEV2&lt;/string&gt;
    &lt;key&gt;PayloadIdentifier&lt;/key&gt;
    &lt;string&gt;{your.payload.identifier}}&lt;/string&gt;
    &lt;key&gt;PayloadRemovalDisallowed&lt;/key&gt;
    &lt;false/&gt;
    &lt;key&gt;PayloadType&lt;/key&gt;
    &lt;string&gt;Configuration&lt;/string&gt;
    &lt;key&gt;PayloadUUID&lt;/key&gt;
    &lt;string&gt;8F74450B-5341-4796-B0AC-9965E64685EB&lt;/string&gt;
    &lt;key&gt;PayloadVersion&lt;/key&gt;
    &lt;integer&gt;1&lt;/integer&gt;
&lt;/dict&gt;
&lt;/plist&gt;
</pre></div>


<p>保存成 .mobileconfig 格式，发到手机里安装就可以了。</p>
<h2 id="_4">参考链接</h2>
<ul>
<li><a href="https://gist.github.com/losisli/11081793">linux上用strongswan搭建ikev2协议vpn</a></li>
<li><a href="https://wiki.strongswan.org/projects/strongswan/wiki/ConnSection">strongSwan configuration</a></li>
</ul>
        </section>
        <div class="post-nav">
    		<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'zqqf16';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

    	</div>
    </div>

</article>

        </section>
    </div>
    <footer class="main-footer">
        <div class="vertical-container">
            <div class="wrapper">
                <p class="copy">&copy; zqqf16</p>
            </div>
        </div>
    </footer>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-41282906-2', 'auto');
      ga('require', 'displayfeatures');
      ga('send', 'pageview');
    </script>
</body>
</html>
