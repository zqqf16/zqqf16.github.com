<!DOCTYPE html>
<html lang="zh-cn">
<head>
  
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
  <title>
iOS çš„å¤šçº¿ç¨‹åŒæ­¥ |
ç©·æŠ˜è…¾</title>
  <link rel="stylesheet" href="/static/css/style.css" />
  <link rel="stylesheet" href="/static/css/pygments.css" />
  <link rel="alternate" type="application/rss+xml" title="RSS" href="http://blog.zorro.im/rss.xml" />
  <link rel="icon" type="image/png" href="/static/img/favicon.png">
</head>
<body>
    <div 
itemscope itemtype="http://schema.org/Article"
 class="page-wrap">
        <section class="main-header regular">
            <div class="vertical-container">
                <div class="wrapper clearfix">
                    <header>
                        <a href="/">
                            <h1 id="main-title">ç©·æŠ˜è…¾</h1>
                            <h2 id="main-subtitle">zqqf16 çš„ä¸ªäººåšå®¢</h2>
                        </a>
                    </header>
                    <nav id="main-nav" role="navigation">
                        <a href="/" class="selected">ä¸»é¡µ</a>
                        <a href="/posts/about.html" class="">å…³äº</a>
                        <a href="https://github.com/zqqf16">Github</a>
                    </nav>
                </div>
            </div>
        </section>
        <section class="main-content">
            
<article class="main-content">
    <div class="wrapper">
        <header class="section-header">
            <h1 itemprop="name" class="section-title">iOS çš„å¤šçº¿ç¨‹åŒæ­¥</h1>
            <span class="section-subtitle"><time itemprop="datePublished" content="2015-08-04" datetime="2015-08-04" pubdate="2015-08-04">2015-08-04</time></span>
        </header>
        <section itemprop="articleBody" class="post-content">
        	<blockquote>
<p>æˆ‘çš„ä¸Šä¸€å®¶å…¬å¸æœ‰ä¸ªå¼•ä»¥ä¸ºè±ªçš„æŠ€æœ¯ï¼šå¤šæ ¸æ— é”ï¼Œä¸ä»…é¿å…äº†å„ç§ç”±é”å¸¦æ¥çš„é—®é¢˜ï¼Œè¿˜æå¤§çš„æé«˜äº†æ€§èƒ½ï¼Œæ‰€ä»¥äº§å“æ€§èƒ½èƒ½å¤Ÿåœ¨ä¸šç•Œæ•°ä¸€æ•°äºŒã€‚
åœ¨è¿™æ ·çš„æ°›å›´å½±å“ä¸‹ï¼Œæˆ‘åœ¨å¼€å‘çš„æ—¶å€™ä¹Ÿå¾ˆå°‘ç”¨é”ï¼Œèƒ½ä¸ç”¨å°±ä¸ç”¨ã€‚
åæ¥å»é¢è¯• iOS å¼€å‘çš„æ—¶å€™ï¼Œé¢è¯•å®˜æ€»æ˜¯å–œæ¬¢é—®æœ‰å…³äºé”çš„é—®é¢˜ï¼Œæœ€è¿‘è¶æœ‰æ—¶é—´å°±æ•´ç†äº†ä¸€ä¸‹ï¼Œç®—æ˜¯è¡¥å……ä¸€ä¸‹æŠ€èƒ½æ ‘å§ã€‚</p>
</blockquote>
<h2 id="mutex">äº’æ–¥é”ï¼ˆMutexï¼‰</h2>
<p>äº’æ–¥é”æ˜¯æ¯”è¾ƒå¸¸ç”¨çš„ä¸€ç§é”ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è¯•å›¾è·å–è¢«å¦ä¸€ä¸ªçº¿ç¨‹å ç”¨çš„é”æ—¶ï¼Œå®ƒå°†ä¼šè¢«æŒ‚èµ·ï¼Œè®©å‡º CPUï¼Œç›´åˆ°è¯¥é”è¢«é‡Šæ”¾ã€‚</p>
<p>åœ¨ iOS ä¸­ï¼Œäº’æ–¥é”æœ‰å¤šç§å®ç°æ–¹å¼ï¼š</p>
<h3 id="posix-api">POSIX Api</h3>
<p>POSIX æ–¹å¼çš„ä¼˜ç‚¹æ˜¯æ¯”è¾ƒé€šç”¨ï¼Œå¯¹é‚£äº›éœ€è¦è·¨å¹³å°çš„ library æ¥è¯´å†åˆé€‚ä¸è¿‡äº†ã€‚</p>
<p>POSIX ä¸­ä¸äº’æ–¥é”æœ‰å…³çš„ä¸»è¦æœ‰ 5 ä¸ªå‡½æ•°ï¼š</p>
<ul>
<li><code>pthread_mutex_init</code> åˆå§‹åŒ–é”</li>
<li><code>pthread_mutex_lock</code> åŠ é”</li>
<li><code>pthread_mutex_tylock</code> åŠ é”ï¼Œå½“é”è¢«å ç”¨æ—¶ï¼Œè¿”å› busyï¼Œä¸æŒ‚èµ·çº¿ç¨‹ã€‚</li>
<li><code>pthread_mutex_unlock</code> é‡Šæ”¾é”</li>
<li><code>pthread_mutex_destroy</code> é”€æ¯é”</li>
</ul>
<p>ä¾‹å­ï¼š</p>
<div class="codehilite"><pre><span class="cp">#include &lt;pthread.h&gt;</span>

<span class="kt">pthread_mutex_t</span> <span class="n">mutex</span><span class="p">;</span>
<span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">mutiThreadMethod</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>

    <span class="c1">// Do something</span>

    <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">destroyLock</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">pthread_mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<h3 id="synchronized">@synchronized</h3>
<p>@synchronized åº”è¯¥æ˜¯ç”¨èµ·æ¥æœ€ç®€å•çš„æ–¹å¼äº†ï¼Œä¾‹å¦‚ï¼š</p>
<div class="codehilite"><pre><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">mutiThreadMethod2</span>
<span class="p">{</span>
    <span class="k">@synchronized</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Do something</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>ç”¨ clang æ”¹å†™ä¸€ä¸‹å°±å¯ä»¥å‘ç°ï¼Œå…¶å®ç¼–è¯‘å™¨ä¸ºè¿™ä¸ªè¯­æ³•ç³–åšäº†å¾ˆå¤šå·¥ä½œï¼Œå¤§è‡´å¦‚ä¸‹ï¼š</p>
<div class="codehilite"><pre><span class="c1">//...</span>

<span class="n">objc_sync_enter</span>
<span class="n">objc_exception_try_enter</span>
<span class="n">setjmp</span>
<span class="n">objc_exception_extract</span>

<span class="c1">// Do something</span>

<span class="n">objc_exception_try_exit</span>
<span class="n">objc_sync_exit</span>
<span class="c1">// ...</span>
<span class="n">objc_exception_throw</span>
<span class="c1">// ...</span>
</pre></div>


<p>å¯ä»¥çœ‹åˆ°åšäº†å¾ˆå¤šä¸é”æœ‰å…³çš„æ“ä½œï¼Œå…¶æ€§èƒ½ä¸å¦‚ POSIX æ–¹å¼ï¼Œå°½ç®¡åè€…éš¾çœ‹äº›ã€‚</p>
<h3 id="nslock">NSLock</h3>
<div class="codehilite"><pre><span class="bp">NSLock</span> <span class="o">*</span><span class="n">lock</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSLock</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>

<span class="c1">// ...</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">mutiThreadMethod3</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">([</span><span class="n">lock</span> <span class="n">tryLock</span><span class="p">])</span> <span class="p">{</span>
        <span class="c1">// Do something</span>
        <span class="c1">// ...</span>
        <span class="p">[</span><span class="n">lock</span> <span class="n">unlock</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h2 id="recursive-lock">é€’å½’é”ï¼ˆRecursive Lockï¼‰</h2>
<p>é€’å½’é”æ˜¯äº’æ–¥é”çš„å˜ä½“ï¼Œå®ƒå…è®¸ä¸€ä¸ªçº¿ç¨‹åœ¨é‡Šæ”¾å®ƒä¹‹å‰å¤šæ¬¡è·å–å®ƒï¼Œå¹¶ä¸”åªæœ‰åœ¨é‡Šæ”¾ç›¸åŒæ¬¡æ•°ä¹‹åå…¶å®ƒçº¿ç¨‹æ‰èƒ½è·å–å®ƒã€‚</p>
<div class="codehilite"><pre><span class="bp">NSRecursiveLock</span> <span class="o">*</span><span class="n">theLock</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSRecursiveLock</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>

<span class="kt">void</span> <span class="nf">MyRecursiveFunction</span><span class="p">(</span><span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">theLock</span> <span class="n">lock</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="o">--</span><span class="n">value</span><span class="p">;</span>
        <span class="n">MyRecursiveFunction</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="p">[</span><span class="n">theLock</span> <span class="n">unlock</span><span class="p">];</span>
<span class="p">}</span>

<span class="n">MyRecursiveFunction</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</pre></div>


<h2 id="read-write-lock">è¯»å†™é”ï¼ˆRead-write Lockï¼‰</h2>
<p>è¯»å†™é”æŠŠè®¿é—®å¯¹è±¡åˆ’åˆ†ä¸º<strong>è¯»è€…</strong>å’Œ<strong>å†™è€…</strong>ï¼Œå½“è¯»å†™é”åœ¨<strong>è¯»åŠ é”</strong>çŠ¶æ€æ—¶ï¼Œæ‰€æœ‰çš„è¯•å›¾ä»¥è¯»åŠ é”æ–¹å¼å¯¹å…¶è¿›è¡ŒåŠ é”æ—¶ï¼Œéƒ½ä¼šè·å¾—è®¿é—®æƒé™ã€‚
æ‰€æœ‰çš„è¯•å›¾ä»¥å†™åŠ é”æ–¹å¼å¯¹å…¶åŠ é”çš„çº¿ç¨‹éƒ½å°†é˜»å¡ï¼Œç›´åˆ°æ‰€æœ‰çš„è¯»é”é‡Šæ”¾ã€‚
å½“åœ¨<strong>å†™åŠ é”</strong>çŠ¶æ€æ—¶ï¼Œæ‰€æœ‰è¯•å›¾å¯¹å…¶åŠ é”çš„çº¿ç¨‹éƒ½å°†é˜»å¡ã€‚</p>
<p>è¯»å†™é”é€‚åˆè¯»æ“ä½œè¿œå¤§äºå†™æ“ä½œçš„æƒ…å†µã€‚</p>
<p>åœ¨ iOS ä¸Šï¼Œè¯»å†™é”å¾—ç”¨ POSIX æ–¹å¼å®ç°ã€‚POSIX æä¾›çš„ç›¸å…³å‡½æ•°å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>pthread_rwlock_init</code> åˆå§‹åŒ–è¯»å†™é”</li>
<li><code>pthread_rwlock_rdlock</code> è¯»åŠ é”</li>
<li><code>pthread_rwlock_wrlock</code> å†™åŠ é”</li>
<li><code>pthread_rwlock_unlock</code> é‡Šæ”¾é”</li>
<li><code>pthread_rwlock_destroy</code> é”€æ¯é”</li>
</ul>
<p>ä¾‹å­ï¼š</p>
<div class="codehilite"><pre><span class="cp">#include &lt;pthread.h&gt;</span>

<span class="kt">pthread_rwlock_t</span> <span class="n">rwlock</span><span class="p">;</span>
<span class="n">pthread_rwlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rwlock</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">mutiThreadWritting</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">pthread_rwlock_wrlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rwlock</span><span class="p">);</span>
    <span class="c1">// write</span>
    <span class="n">pthread_rwlock_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rwlock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mutiThreadReadding</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">pthread_rwlock_rdlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rwlock</span><span class="p">);</span>
    <span class="c1">// read</span>
    <span class="n">pthread_rwlock_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rwlock</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<h2 id="spin-lock">è‡ªæ—‹é”ï¼ˆSpin Lockï¼‰</h2>
<p>è‡ªæ—‹é”ä¸äº’æ–¥é”ä¸åŒçš„åœ°æ–¹åœ¨äºï¼Œè‡ªæ—‹é”æ˜¯éé˜»å¡çš„ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹æ— æ³•è·å–è‡ªæ—‹é”æ—¶ï¼Œä¼šè‡ªæ—‹ï¼Œç›´åˆ°è¯¥é”è¢«é‡Šæ”¾ï¼Œç­‰å¾…çš„è¿‡ç¨‹ä¸­çº¿ç¨‹å¹¶ä¸ä¼šæŒ‚èµ·ã€‚</p>
<p>å®ƒçš„ä¼˜ç‚¹æ˜¯æ•ˆç‡é«˜ï¼Œä¸ç”¨è¿›è¡Œçº¿ç¨‹åˆ‡æ¢ã€‚ç¼ºç‚¹æ˜¯å¦‚æœä¸€ä¸ªçº¿ç¨‹éœ¸å é”çš„æ—¶é—´è¿‡é•¿ï¼Œè‡ªæ—‹ä¼šæ¶ˆè€— CPU èµ„æºã€‚</p>
<div class="codehilite"><pre><span class="cp">#import &lt;libkern/OSAtomic.h&gt;</span>

<span class="k">static</span> <span class="n">OSSpinLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">OS_SPINLOCK_INIT</span><span class="p">;</span>

<span class="kt">void</span> <span class="n">mutiThreadMethod4</span>
<span class="p">{</span>
    <span class="n">OSSpinLockLock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
    <span class="c1">// Do something</span>
    <span class="n">OSSpinLockUnlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<h2 id="distributed-lock">åˆ†å¸ƒé”ï¼ˆDistributed Lockï¼‰</h2>
<p>ä¸¥æ ¼æ¥è¯´ï¼Œåˆ†å¸ƒé”æ˜¯è¿›ç¨‹é—´åŒæ­¥çš„å·¥å…·ï¼Œæœ‰ç‚¹åƒ Unix ä¸‹çš„å„ç§ lock æ–‡ä»¶ï¼Œæ¯”å¦‚ apt-get çš„ â€œ/var/lib/apt/lists/lockâ€ã€‚</p>
<p>å®ƒå¹¶ä¸å¼ºåˆ¶è¿›ç¨‹ä¼‘çœ ï¼Œåªæ˜¯èµ·åˆ°å‘ŠçŸ¥çš„ä½œç”¨ã€‚å…·ä½“å¦‚ä½•å¤„ç†èµ„æºè¢«å ï¼Œå®Œå…¨ç”±è¿›ç¨‹è‡ªå·±å†³å®šã€‚</p>
<p>iOS ä¸Šå‡ æœ¬ç”¨ä¸ä¸Šåˆ†å¸ƒé”ï¼Œåœ¨ OS X ä¸­ï¼Œå¯ä»¥ç”¨ <strong>NSDistributedLock</strong> å®ç°ï¼š</p>
<div class="codehilite"><pre><span class="n">NSDistributedLock</span> <span class="o">*</span><span class="n">lock</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSDistributedLock</span> <span class="nl">lockWithPath</span><span class="p">:</span><span class="n">path</span><span class="p">];</span>

<span class="c1">// ...</span>

<span class="k">if</span> <span class="p">([</span><span class="n">lock</span> <span class="n">tryLock</span><span class="p">])</span> <span class="p">{</span>
    <span class="c1">// Do something</span>
    <span class="p">[</span><span class="n">lock</span> <span class="n">unlock</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>


<p>æˆ–è€…ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡å†™ lock æ–‡ä»¶çš„æ–¹å¼æ¥å®ç°ã€‚</p>
<h2 id="condition-variable">æ¡ä»¶å˜é‡ï¼ˆCondition Variableï¼‰</h2>
<p>å¦‚æœä¸€ä¸ªçº¿ç¨‹éœ€è¦ç­‰å¾…æŸä¸€æ¡ä»¶æ‰èƒ½ç»§ç»­æ‰§è¡Œï¼Œè€Œè¿™ä¸ªæ¡ä»¶æ˜¯ç”±åˆ«çš„çº¿ç¨‹äº§ç”Ÿçš„ï¼Œè¿™æ—¶å€™åªç”¨é”å°±æœ‰ç‚¹æ‰è¥Ÿè§è‚˜äº†ã€‚è¦ä¹ˆä¸åœçš„è½®è¯¢ï¼Œæ¶ˆè€—èµ„æºï¼Œè¦ä¹ˆæ¯éš”ä¸€æ®µæ—¶é—´æŸ¥è¯¢ä¸€æ¬¡ï¼Œä¸§å¤±äº†åŠæ—¶æ€§ã€‚
æ¡ä»¶å˜é‡å°±æ˜¯ä¸ºäº†æ»¡è¶³è¿™ç§åœºæ™¯è€Œç”Ÿçš„ï¼Œå®ƒå¯ä»¥è®©ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…æŸä¸€æ¡ä»¶ï¼Œå½“æ¡ä»¶æ»¡è¶³æ—¶ï¼Œä¼šæ”¶åˆ°é€šçŸ¥ã€‚
åœ¨è·å–æ¡ä»¶å˜é‡å¹¶ç­‰å¾…æ¡ä»¶å‘ç”Ÿçš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿä¼šäº§ç”Ÿå¤šçº¿ç¨‹çš„ç«äº‰ï¼Œæ‰€ä»¥æ¡ä»¶å˜é‡é€šå¸¸ä¼šå’Œäº’æ–¥é”ä¸€èµ·å·¥ä½œã€‚</p>
<p>iOS ä¸­ï¼Œæ¡ä»¶å˜é‡æœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼š</p>
<h3 id="posix">POSIX</h3>
<p>POSIX æä¾›çš„ç›¸å…³å‡½æ•°å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>pthread_cond_init</code> åˆå§‹åŒ–</li>
<li><code>pthread_cond_wait</code> ç­‰å¾…æ¡ä»¶</li>
<li><code>pthread_cond_broadcast</code> å‘é€å¹¿æ’­ï¼Œå”¤é†’æ‰€æœ‰æ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹</li>
<li><code>pthread_cond_signal</code> å‘é€ä¿¡å·ï¼Œå”¤é†’ç¬¬ä¸€ä¸ªçº¿ç¨‹</li>
<li><code>pthread_cond_destroy</code> é”€æ¯</li>
</ul>
<p>ä¾‹å­ï¼š</p>
<div class="codehilite"><pre><span class="cp">#include &lt;pthread.h&gt;</span>

<span class="k">static</span> <span class="kt">pthread_mutex_t</span> <span class="n">mutex</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">pthread_cond_t</span> <span class="n">condition</span><span class="p">;</span>

<span class="c1">// ...</span>

<span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="n">pthread_cond_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">condition</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="c1">// ...</span>

<span class="kt">void</span> <span class="nf">waitCondition</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pthread_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">condition</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">triggerCondition</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>

    <span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
    <span class="n">pthread_cond_broadcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">condition</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// ...</span>

<span class="n">pthread_mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="n">pthread_cond_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">condition</span><span class="p">);</span>
</pre></div>


<h3 id="nscondition">NSCondition</h3>
<p>ä¾‹å­æ‘˜è‡ª <a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/Multithreading/ThreadSafety/ThreadSafety.html">Threading Programming Guide</a></p>
<div class="codehilite"><pre><span class="p">[</span><span class="n">cocoaCondition</span> <span class="n">lock</span><span class="p">];</span>
<span class="k">while</span> <span class="p">(</span><span class="n">timeToDoWork</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">[</span><span class="n">cocoaCondition</span> <span class="n">wait</span><span class="p">];</span>

<span class="n">timeToDoWork</span><span class="o">--</span><span class="p">;</span>

<span class="c1">// Do real work here.</span>

<span class="p">[</span><span class="n">cocoaCondition</span> <span class="n">unlock</span><span class="p">];</span>
</pre></div>


<p>å‘é€ä¿¡å·ï¼š</p>
<div class="codehilite"><pre><span class="p">[</span><span class="n">cocoaCondition</span> <span class="n">lock</span><span class="p">];</span>
<span class="n">timeToDoWork</span><span class="o">++</span><span class="p">;</span>
<span class="p">[</span><span class="n">cocoaCondition</span> <span class="n">signal</span><span class="p">];</span>
<span class="p">[</span><span class="n">cocoaCondition</span> <span class="n">unlock</span><span class="p">];</span>
</pre></div>


<h2 id="nsconditionlock">NSConditionLock</h2>
<p>NSConditionLock è·Ÿ NSCondition ç±»ä¼¼ï¼Œä½†æ˜¯å®ç°æœºåˆ¶æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ‰€ä»¥å•ç‹¬åˆ—äº†å‡ºæ¥ã€‚</p>
<p>ä¾‹å­ï¼š</p>
<p>ç”Ÿäº§è€…</p>
<div class="codehilite"><pre><span class="kt">id</span> <span class="n">condLock</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSConditionLock</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithCondition</span><span class="p">:</span><span class="n">NO_DATA</span><span class="p">];</span>

<span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">condLock</span> <span class="n">lock</span><span class="p">];</span>
    <span class="c1">// Add data to the queue.</span>
    <span class="p">[</span><span class="n">condLock</span> <span class="nl">unlockWithCondition</span><span class="p">:</span><span class="n">HAS_DATA</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>


<p>æ¶ˆè´¹è€…</p>
<div class="codehilite"><pre><span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">condLock</span> <span class="nl">lockWhenCondition</span><span class="p">:</span><span class="n">HAS_DATA</span><span class="p">];</span>
    <span class="c1">// Remove data from the queue.</span>
    <span class="p">[</span><span class="n">condLock</span> <span class="nl">unlockWithCondition</span><span class="p">:(</span><span class="n">isEmpty</span> <span class="o">?</span> <span class="nl">NO_DATA</span> <span class="p">:</span> <span class="n">HAS_DATA</span><span class="p">)];</span>

    <span class="c1">// Process the data locally.</span>
<span class="p">}</span>
</pre></div>


<h2 id="semaphore">ä¿¡å·é‡ï¼ˆSemaphoreï¼‰</h2>
<p>ä¿¡å·é‡å¯ä»¥çœ‹æˆæ˜¯ä¸€ç§ç‰¹æ®Šçš„äº’æ–¥é”ï¼Œä¸åŒçš„æ˜¯ï¼Œå®ƒå¯ä»¥ä¸åªæœ‰ä¸¤ä¸ªçŠ¶æ€ï¼Œå®ƒå¯ä»¥æ˜¯èµ„æºçš„è®¡æ•°å™¨ã€‚è¿˜è®°å¾—ã€Šæ“ä½œç³»ç»Ÿã€‹ä¸­å­¦è¿‡çš„ PV æ“ä½œä¹ˆï¼Ÿ</p>
<p>iOS ä¸­ï¼Œä¿¡å·é‡æœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼š</p>
<h3 id="posix_1">POSIX</h3>
<p>POSIX æä¾›çš„ç›¸å…³å‡½æ•°å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>sem_init</code> åˆå§‹åŒ–</li>
<li><code>sem_post</code> ç»™ä¿¡å·é‡çš„å€¼åŠ ä¸€ï¼ˆV æ“ä½œï¼‰</li>
<li><code>sem_wait</code> ç»™ä¿¡å·é‡çš„å€¼å‡ä¸€ï¼ˆP æ“ä½œï¼‰</li>
<li><code>sem_getvalue</code> è¿”å›ä¿¡å·é‡çš„å€¼</li>
<li><code>sem_destroy</code> é”€æ¯</li>
</ul>
<h3 id="gcd">GCD ä¿¡å·é‡</h3>
<p>GCD æä¾›çš„å‡½æ•°å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>dispatch_semaphore_create</code> åˆ›å»ºä¿¡å·é‡</li>
<li><code>dispatch_semaphore_signal</code> å‘é€ä¿¡å·ï¼ˆä¿¡å·é‡åŠ ä¸€ï¼ŒV æ“ä½œï¼‰</li>
<li><code>dispatch_semaphore_wait</code>ç­‰å¾…ä¿¡å·ï¼ˆä¿¡å·é‡å‡ä¸€ï¼ŒP æ“ä½œï¼‰</li>
</ul>
<p>ä¾‹å­ï¼š</p>
<div class="codehilite"><pre><span class="kt">dispatch_semaphore_t</span> <span class="n">semaphore</span> <span class="o">=</span> <span class="n">dispatch_semaphore_create</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

<span class="c1">// ...</span>

<span class="n">dispatch_semaphore_wait</span><span class="p">(</span><span class="n">semaphore</span><span class="p">,</span> <span class="n">DISPATCH_TIME_FOREVER</span><span class="p">);</span>
<span class="c1">// Do something</span>
<span class="n">dispatch_semaphore_signal</span><span class="p">(</span><span class="n">semaphore</span><span class="p">);</span>
</pre></div>


<h2 id="barrier">æ …æ ï¼å±éšœï¼ˆBarrierï¼‰</h2>
<p>å¦‚æœä¸€ä¸ªçº¿ç¨‹éœ€è¦ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„æŸäº›æ“ä½œä¹‹åæ‰èƒ½ç»§ç»­æ‰§è¡Œï¼Œå¯ä»¥ç”¨ä¸Šé¢æ‰€è¯´çš„æ¡ä»¶å˜é‡æ¥å®ç°ï¼Œè¿˜æœ‰ä¸€ç§ä¼˜é›…çš„å®ç°æ–¹å¼ â€”â€” Barrierã€‚
å½¢è±¡ç‚¹è¯´ï¼Œå°±æ˜¯æŠŠçº¿ç¨‹æŒ¡åœ¨åŒä¸€ä¸ª Barrier ä¹‹å‰ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½è¾¾åˆ° Barrier ä¹‹åï¼Œç»Ÿä¸€æ”¾è¡Œã€‚</p>
<p>åŒæ ·ï¼ŒiOS ä¸­æœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼š</p>
<h3 id="posix_2">POSIX</h3>
<p>ç›¸å…³å‡½æ•°å¦‚ä¸‹ï¼š
- <code>pthread_barrier_init</code> åˆ›å»º barrier
- <code>pthread_barrier_wait</code> å‘ŠçŸ¥å½“å‰çº¿ç¨‹å·²ç»åˆ°è¾¾ barrierï¼Œç­‰æ‰€æœ‰çº¿ç¨‹éƒ½å‘ŠçŸ¥åï¼Œä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œ
- <code>pthread_barrier_destroy</code> é”€æ¯</p>
<h3 id="dispatch-barrier">Dispatch Barrier</h3>
<p>Dispatch Barrier çš„æ¦‚å¿µè·Ÿ POSIX ç±»ä¼¼ï¼Œä¸åŒçš„æ˜¯å®ƒæ˜¯é’ˆå¯¹äº GCD å¼‚æ­¥ä»»åŠ¡çš„ã€‚å®ƒå¯ä»¥è®©åœ¨å®ƒä¹‹å‰æäº¤çš„å¼‚æ­¥ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæˆä¹‹åå†æ‰§è¡Œã€‚</p>
<p>ä¾‹å­ï¼š</p>
<div class="codehilite"><pre><span class="n">dispatch_async</span><span class="p">(</span><span class="n">async_queue</span><span class="p">,</span> <span class="n">block1</span><span class="p">);</span>
<span class="n">dispatch_async</span><span class="p">(</span><span class="n">async_queue</span><span class="p">,</span> <span class="n">block2</span><span class="p">);</span>
<span class="c1">// block3 ä¼šåœ¨ block1 å’Œ block2 æ‰§è¡Œå®Œæˆä¹‹åå†æ‰§è¡Œ</span>
<span class="n">dispatch_barrier_async</span><span class="p">(</span><span class="n">async_queue</span><span class="p">,</span> <span class="n">block3</span><span class="p">);</span>
<span class="c1">// block4 å’Œ block5 ä¼šåœ¨ block3 ä¹‹åæ‰§è¡Œ</span>
<span class="n">dispatch_async</span><span class="p">(</span><span class="n">async_queue</span><span class="p">,</span> <span class="n">block4</span><span class="p">);</span>
<span class="n">dispatch_async</span><span class="p">(</span><span class="n">async_queue</span><span class="p">,</span> <span class="n">block5</span><span class="p">);</span>
</pre></div>


<h2 id="_1">åè®°</h2>
<p><strong>é”</strong> è¿™ä¸ªä¸œè¥¿å¯è°“ â€œå°ç”¨æ€¡æƒ…ï¼Œæ»¥ç”¨ä¼¤èº«â€ï¼Œç”¨çš„æ—¶å€™ä¸€ä¸å°å¿ƒå°±ä¼šæœ‰å„ç§å„æ ·çš„é—®é¢˜ï¼Œæ¯”å¦‚æ­»é”ï¼Œæˆ‘æ›¾ç»å°±è¿™æ ·å†™è¿‡ï¼š</p>
<div class="codehilite"><pre><span class="kt">void</span> <span class="nf">func</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">LOCK</span><span class="p">;</span>

    <span class="c1">//...</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">someCondition</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">UNLOCK</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>åœ¨ iOS ä¸­ï¼Œå¾ˆå¤šæ—¶å€™éƒ½å¯ä»¥ç”¨ GCD çš„ä¸²è¡Œé˜Ÿåˆ—æ¥é¿å…ä½¿ç”¨é”ï¼š</p>
<div class="codehilite"><pre><span class="n">dispatch_async</span><span class="p">(</span><span class="n">serialQueue</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
</pre></div>


<p>å› ä¸ºä¸²è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªï¼Œæ‰€ä»¥å°±ä¸å­˜åœ¨èµ„æºçš„ç«äº‰ï¼Œè¿˜èƒ½æœ‰æ•ˆçš„é¿å…æ­»é”é—®é¢˜ã€‚</p>
<p>ğŸ˜„</p>
        </section>

		<meta itemprop="url" content="posts/iOS-muti-threading-synchronization.html">
		<span itemprop="author" itemscope itemtype="http://schema.org/Person">
			<meta itemprop="name" content="zqqf16"></span>

        <div class="post-nav">
    		<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'zqqf16';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

    	</div>
    </div>

</article>

        </section>
    </div>
    <footer class="main-footer">
        <div class="vertical-container">
            <div class="wrapper">
                <p class="copy">&copy; zqqf16</p>
            </div>
        </div>
    </footer>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-41282906-2', 'auto');
      ga('require', 'displayfeatures');
      ga('send', 'pageview');
    </script>
</body>
</html>
